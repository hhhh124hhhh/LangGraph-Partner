import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { apiService } from '@services/index';
import {
  LangGraphState,
  MemoryNetwork,
  KnowledgeSearchRequest as LegacyKnowledgeSearchRequest,
  KnowledgeSearchResponse as LegacyKnowledgeSearchResponse,
  KnowledgeSearchRequest,
  DemoScenario,
  ComparisonRequest,
  ComparisonResponse,
  PersonaUpdateRequest,
  KnowledgeStats,
  KnowledgeDocument,
  TagStats,
  DocumentUploadRequest,
  DocumentUploadResponse,
  SimilarDocument,
  RebuildIndexResponse,
} from '@typesdef/index';

// 查询键工厂
export const queryKeys = {
  // 对话相关
  chatState: (sessionId: string) => ['chat', 'state', sessionId] as const,

  // 记忆网络相关
  memoryNetwork: (sessionId: string) => ['memory', 'network', sessionId] as const,

  // 知识检索相关
  knowledgeSearch: (request: LegacyKnowledgeSearchRequest) => ['knowledge', 'search', request] as const,

  // 演示相关
  demoScenarios: () => ['demo', 'scenarios'] as const,

  // 对比分析相关
  comparison: (request: ComparisonRequest) => ['comparison', 'analyze', request] as const,

  // 通用查询
  health: () => ['health'] as const,

  // 知识库相关
  knowledgeStats: () => ['knowledge', 'stats'] as const,
  knowledgeDocuments: (params?: any) => ['knowledge', 'documents', params] as const,
  knowledgeDocument: (docId: string) => ['knowledge', 'document', docId] as const,
  knowledgeTags: () => ['knowledge', 'tags'] as const,
  similarDocuments: (docId: string) => ['knowledge', 'similar', docId] as const,
} as const;

// 对话状态查询
export const useChatStateQuery = (sessionId: string) => {
  return useQuery({
    queryKey: queryKeys.chatState(sessionId),
    queryFn: () => apiService.getChatState(sessionId),
    enabled: !!sessionId,
    refetchInterval: 5000, // 每5秒刷新一次
    staleTime: 1000, // 1秒内数据被认为是新鲜的
  });
};

// 记忆网络查询
export const useMemoryNetworkQuery = (sessionId: string) => {
  return useQuery({
    queryKey: queryKeys.memoryNetwork(sessionId),
    queryFn: () => apiService.getMemoryNetwork(sessionId),
    enabled: !!sessionId,
    staleTime: 30000, // 30秒内数据被认为是新鲜的
  });
};

// 知识检索查询
export const useKnowledgeSearchQuery = (request: LegacyKnowledgeSearchRequest, enabled = true) => {
  return useQuery({
    queryKey: queryKeys.knowledgeSearch(request),
    queryFn: () => apiService.searchKnowledge(request),
    enabled: enabled && !!request.query,
    staleTime: 60000, // 1分钟内数据被认为是新鲜的
  });
};

// 演示场景查询
export const useDemoScenariosQuery = () => {
  return useQuery({
    queryKey: queryKeys.demoScenarios(),
    queryFn: () => apiService.getDemoScenarios(),
    staleTime: 10 * 60 * 1000, // 10分钟内数据被认为是新鲜的
  });
};

// 对比分析查询
export const useComparisonQuery = (request: ComparisonRequest, enabled = true) => {
  return useQuery({
    queryKey: queryKeys.comparison(request),
    queryFn: () => apiService.analyzeComparison(request),
    enabled: enabled && !!request.session_id,
    staleTime: 5 * 60 * 1000, // 5分钟内数据被认为是新鲜的
  });
};

// 健康检查查询
export const useHealthQuery = () => {
  return useQuery({
    queryKey: queryKeys.health(),
    queryFn: () => apiService.healthCheck(),
    refetchInterval: 30000, // 每30秒检查一次
    retry: 3,
  });
};

// 变更相关hooks

// 画像更新变更
export const usePersonaUpdateMutation = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (request: PersonaUpdateRequest) => apiService.updatePersona(request),
    onSuccess: () => {
      // 更新相关的查询缓存
      queryClient.invalidateQueries({ queryKey: ['chat'] });
    },
    onError: (error) => {
      console.error('[Mutation] Persona update failed:', error);
    },
  });
};

// 知识检索变更（对话系统）
export const useLegacyKnowledgeSearchMutation = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (request: LegacyKnowledgeSearchRequest) => apiService.searchKnowledge(request),
    onSuccess: (data, variables) => {
      // 更新缓存
      queryClient.setQueryData(
        queryKeys.knowledgeSearch(variables),
        data
      );
    },
    onError: (error) => {
      console.error('[Mutation] Knowledge search failed:', error);
    },
  });
};

// 对比分析变更
export const useComparisonMutation = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (request: ComparisonRequest) => apiService.analyzeComparison(request),
    onSuccess: (data, variables) => {
      // 更新缓存
      queryClient.setQueryData(
        queryKeys.comparison(variables),
        data
      );
    },
    onError: (error) => {
      console.error('[Mutation] Comparison analysis failed:', error);
    },
  });
};

// 通用工具hooks

// 无效化所有查询
export const useInvalidateAllQueries = () => {
  const queryClient = useQueryClient();

  return () => {
    queryClient.invalidateQueries();
  };
};

// 预取数据
export const usePrefetchData = () => {
  const queryClient = useQueryClient();

  const prefetchChatState = (sessionId: string) => {
    queryClient.prefetchQuery({
      queryKey: queryKeys.chatState(sessionId),
      queryFn: () => apiService.getChatState(sessionId),
      staleTime: 1000,
    });
  };

  const prefetchMemoryNetwork = (sessionId: string) => {
    queryClient.prefetchQuery({
      queryKey: queryKeys.memoryNetwork(sessionId),
      queryFn: () => apiService.getMemoryNetwork(sessionId),
      staleTime: 30000,
    });
  };

  const prefetchDemoScenarios = () => {
    queryClient.prefetchQuery({
      queryKey: queryKeys.demoScenarios(),
      queryFn: () => apiService.getDemoScenarios(),
      staleTime: 10 * 60 * 1000,
    });
  };

  return {
    prefetchChatState,
    prefetchMemoryNetwork,
    prefetchDemoScenarios,
  };
};

// 乐观更新工具
export const useOptimisticUpdate = () => {
  const queryClient = useQueryClient();

  const updateChatStateOptimistically = (sessionId: string, newData: Partial<LangGraphState>) => {
    queryClient.setQueryData(
      queryKeys.chatState(sessionId),
      (old: LangGraphState | undefined) => {
        if (!old) return old;
        return { ...old, ...newData };
      }
    );
  };

  const updateMemoryNetworkOptimistically = (sessionId: string, newData: Partial<MemoryNetwork>) => {
    queryClient.setQueryData(
      queryKeys.memoryNetwork(sessionId),
      (old: MemoryNetwork | undefined) => {
        if (!old) return old;
        return { ...old, ...newData };
      }
    );
  };

  return {
    updateChatStateOptimistically,
    updateMemoryNetworkOptimistically,
  };
};

// ============ 知识库相关查询 hooks ============

// 知识库统计查询
export const useKnowledgeStatsQuery = () => {
  return useQuery({
    queryKey: queryKeys.knowledgeStats(),
    queryFn: () => apiService.getKnowledgeStats(),
    staleTime: 5 * 60 * 1000, // 5分钟内数据被认为是新鲜的
    refetchInterval: 10 * 60 * 1000, // 每10分钟刷新一次
  });
};

// 知识库文档列表查询
export const useKnowledgeDocumentsQuery = (params?: {
  page?: number;
  page_size?: number;
  tags?: string[];
  category?: string;
  sort_by?: string;
  sort_order?: 'asc' | 'desc';
}) => {
  return useQuery({
    queryKey: queryKeys.knowledgeDocuments(params),
    queryFn: () => apiService.getKnowledgeDocuments(params),
    staleTime: 2 * 60 * 1000, // 2分钟内数据被认为是新鲜的
    keepPreviousData: true, // 保持之前的数据，避免闪烁
  });
};

// 知识库文档详情查询
export const useKnowledgeDocumentQuery = (docId: string, enabled = true) => {
  return useQuery({
    queryKey: queryKeys.knowledgeDocument(docId),
    queryFn: () => apiService.getKnowledgeDocument(docId),
    enabled: enabled && !!docId,
    staleTime: 5 * 60 * 1000, // 5分钟内数据被认为是新鲜的
  });
};

// 知识库标签统计查询
export const useKnowledgeTagsQuery = () => {
  return useQuery({
    queryKey: queryKeys.knowledgeTags(),
    queryFn: () => apiService.getKnowledgeTags(),
    staleTime: 10 * 60 * 1000, // 10分钟内数据被认为是新鲜的
  });
};

// 相似文档查询
export const useSimilarDocumentsQuery = (docId: string, limit?: number, enabled = true) => {
  return useQuery({
    queryKey: queryKeys.similarDocuments(docId),
    queryFn: () => apiService.getSimilarDocuments(docId, limit),
    enabled: enabled && !!docId,
    staleTime: 5 * 60 * 1000, // 5分钟内数据被认为是新鲜的
  });
};

// ============ 知识库相关变更 hooks ============

// 文档上传变更
export const useDocumentUploadMutation = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: ({ request, onProgress }: {
      request: DocumentUploadRequest;
      onProgress?: (progress: number) => void;
    }) => apiService.uploadDocument(request, onProgress),
    onSuccess: () => {
      // 更新相关的查询缓存
      queryClient.invalidateQueries({ queryKey: ['knowledge'] });
    },
    onError: (error) => {
      console.error('[Mutation] Document upload failed:', error);
    },
  });
};

// 文档删除变更
export const useDocumentDeleteMutation = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (docId: string) => apiService.deleteKnowledgeDocument(docId),
    onSuccess: () => {
      // 更新相关的查询缓存
      queryClient.invalidateQueries({ queryKey: ['knowledge'] });
    },
    onError: (error) => {
      console.error('[Mutation] Document delete failed:', error);
    },
  });
};

// 重建索引变更
export const useRebuildIndexMutation = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: () => apiService.rebuildKnowledgeIndex(),
    onSuccess: () => {
      // 更新相关的查询缓存
      queryClient.invalidateQueries({ queryKey: ['knowledge'] });
    },
    onError: (error) => {
      console.error('[Mutation] Rebuild index failed:', error);
    },
  });
};

// 知识库搜索变更
export const useKnowledgeSearchMutation = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: (request: KnowledgeSearchRequest) => apiService.searchKnowledgeDocuments(request),
    onSuccess: (data, variables) => {
      // 缓存搜索结果
      queryClient.setQueryData(
        queryKeys.knowledgeSearch(variables),
        data
      );
    },
    onError: (error) => {
      console.error('[Mutation] Knowledge search failed:', error);
    },
  });
};